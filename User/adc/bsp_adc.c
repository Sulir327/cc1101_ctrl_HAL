/**
  ******************************************************************************
  * @file    bsp_bsp_adc.c
  * @author  phoenix
  * @version V1.0
  * @date    10-November-2017
  * @brief   adc driver
  ******************************************************************************
  * @attention
  *
  *
  ******************************************************************************
  */ 
#include "./adc/bsp_adc.h"

uint16_t ADC_ConvertedValue[3];
DMA_HandleTypeDef DMA_Init_Handle;
ADC_HandleTypeDef ADC_Handle1;
ADC_HandleTypeDef ADC_Handle2;
ADC_HandleTypeDef ADC_Handle3;
ADC_ChannelConfTypeDef ADC_Config;

static void MMA7361L_ADC_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	
	// 使能 GPIO 时钟
	MMA7361L_SL_GPIO_CLK_ENABLE();
	MMA7361L_GS_GPIO_CLK_ENABLE();
	MMA7361L_ADC1_GPIO_CLK_ENABLE();
	MMA7361L_ADC2_GPIO_CLK_ENABLE();
	MMA7361L_ADC3_GPIO_CLK_ENABLE();
		
	// 配置 IO
	GPIO_InitStructure.Pin = MMA7361L_ADC1_GPIO_PIN;
	GPIO_InitStructure.Mode = GPIO_MODE_ANALOG;	    
  GPIO_InitStructure.Pull = GPIO_NOPULL ; //不上拉不下拉
	HAL_GPIO_Init(MMA7361L_ADC1_GPIO_PORT, &GPIO_InitStructure);

	// 配置 IO
	GPIO_InitStructure.Pin = MMA7361L_ADC2_GPIO_PIN;
	GPIO_InitStructure.Mode = GPIO_MODE_ANALOG;	    
  GPIO_InitStructure.Pull = GPIO_NOPULL ; //不上拉不下拉
	HAL_GPIO_Init(MMA7361L_ADC2_GPIO_PORT, &GPIO_InitStructure);
	
	// 配置 IO
	GPIO_InitStructure.Pin = MMA7361L_ADC3_GPIO_PIN;
	GPIO_InitStructure.Mode = GPIO_MODE_ANALOG;	    
  GPIO_InitStructure.Pull = GPIO_NOPULL ; //不上拉不下拉
	HAL_GPIO_Init(MMA7361L_ADC3_GPIO_PORT, &GPIO_InitStructure);

	// 配置 IO
	GPIO_InitStructure.Pin = MMA7361L_SL_GPIO_PIN;
	GPIO_InitStructure.Mode = GPIO_MODE_OUTPUT_PP;
	GPIO_InitStructure.Pull  = GPIO_NOPULL;
	GPIO_InitStructure.Speed = GPIO_SPEED_HIGH;
	HAL_GPIO_Init(MMA7361L_SL_GPIO_PORT, &GPIO_InitStructure);
	
	// 配置 IO
	GPIO_InitStructure.Pin = MMA7361L_GS_GPIO_PIN;
	HAL_GPIO_Init(MMA7361L_GS_GPIO_PORT, &GPIO_InitStructure);
}

static void MMA7361L_ADC_Mode_Config(void)
{
	ADC_MultiModeTypeDef   mode;
  // ------------------DMA Init 结构体参数 初始化--------------------------
  // ADC1使用DMA2，数据流0，通道0，这个是手册固定死的
  // 开启DMA时钟
  MMA7361L_ADC_DMA_CLK_ENABLE(); 
	// 数据传输通道
	DMA_Init_Handle.Instance = MMA7361L_ADC_DMA_STREAM;	
  // 数据传输方向为外设到存储器
	DMA_Init_Handle.Init.Direction = DMA_PERIPH_TO_MEMORY;	
	// 外设寄存器只有一个，地址不用递增
	DMA_Init_Handle.Init.PeriphInc = DMA_PINC_DISABLE;
  // 存储器地址固定
	DMA_Init_Handle.Init.MemInc = DMA_MINC_ENABLE; 
  // 外设数据大小为半字，即两个字节
	DMA_Init_Handle.Init.PeriphDataAlignment = DMA_PDATAALIGN_HALFWORD; 
  // 存储器数据大小也为半字，跟外设数据大小相同
	DMA_Init_Handle.Init.MemDataAlignment = DMA_MDATAALIGN_HALFWORD;	
	// 循环传输模式
	DMA_Init_Handle.Init.Mode = DMA_CIRCULAR;
  // DMA 传输通道优先级为高，当使用一个DMA通道时，优先级设置不影响
	DMA_Init_Handle.Init.Priority = DMA_PRIORITY_HIGH;
  // 禁止DMA FIFO	，使用直连模式
  DMA_Init_Handle.Init.FIFOMode = DMA_FIFOMODE_DISABLE;  
  // FIFO 大小，FIFO模式禁止时，这个不用配置	
  DMA_Init_Handle.Init.FIFOThreshold = DMA_FIFO_THRESHOLD_HALFFULL;
  DMA_Init_Handle.Init.MemBurst = DMA_MBURST_SINGLE;
  DMA_Init_Handle.Init.PeriphBurst = DMA_PBURST_SINGLE;  
	// 选择 DMA 通道，通道存在于流中
  DMA_Init_Handle.Init.Channel = MMA7361L_ADC_DMA_CHANNEL;
  // 初始化DMA流，流相当于一个大的管道，管道里面有很多通道
	HAL_DMA_Init(&DMA_Init_Handle);
	
	
	// 开启ADC时钟
	MMA7361L_ADC1_CLK_ENABLE();
  MMA7361L_ADC2_CLK_ENABLE();
	MMA7361L_ADC3_CLK_ENABLE();
	
  // -------------------ADC1 Init 结构体 参数 初始化--------------------------
	ADC_Handle1.Instance = MMA7361L_ADC1;
	// 时钟为fpclk 4分频
  ADC_Handle1.Init.ClockPrescaler = ADC_CLOCKPRESCALER_PCLK_DIV4;
  // ADC 分辨率
  ADC_Handle1.Init.Resolution = ADC_RESOLUTION_12B;
  // 禁止扫描模式，多通道采集才需要	
  ADC_Handle1.Init.ScanConvMode = DISABLE; 
  // 连续转换	
  ADC_Handle1.Init.ContinuousConvMode = ENABLE;
	// 非连续转换
	ADC_Handle1.Init.DiscontinuousConvMode = DISABLE;
	// 非连续转换个数
	ADC_Handle1.Init.NbrOfDiscConversion = 0;	
  // 禁止外部边沿触发
  ADC_Handle1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  // 外部触发通道，本例子使用软件触发，此值随便赋值即可
  //ADC_Handle1.Init.ExternalTrigConv = ADC_EXTERNALTRIGCONV_T1_CC1;
  // 数据右对齐	
  ADC_Handle1.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  // 转换通道 1个
  ADC_Handle1.Init.NbrOfConversion = 1;
	//使能连续转换请求
	ADC_Handle1.Init.DMAContinuousRequests = ENABLE;
	//转换完成标志
	ADC_Handle1.Init.EOCSelection = DISABLE;    
	// 初始化ADC	                          
	HAL_ADC_Init(&ADC_Handle1);
	
  //---------------------------------------------------------------------------	
	// 配置 ADC1 通道13转换顺序为1，第一个转换，采样时间为3个时钟周期
	ADC_Config.Channel      = MMA7361L_ADC1_CHANNEL;
	ADC_Config.Rank         = 1;    
	ADC_Config.SamplingTime = ADC_SAMPLETIME_3CYCLES;// 采样时间间隔	
	ADC_Config.Offset       = 0;
	HAL_ADC_ConfigChannel(&ADC_Handle1, &ADC_Config);
  //---------------------------------------------------------------------------

  // -------------------ADC2 Init 结构体 参数 初始化--------------------------
	ADC_Handle2.Instance = MMA7361L_ADC2;
	// 时钟为fpclk 4分频
  ADC_Handle2.Init.ClockPrescaler = ADC_CLOCKPRESCALER_PCLK_DIV4;
  // ADC 分辨率
  ADC_Handle2.Init.Resolution = ADC_RESOLUTION_12B;
  // 禁止扫描模式，多通道采集才需要	
  ADC_Handle2.Init.ScanConvMode = DISABLE; 
  // 连续转换	
  ADC_Handle2.Init.ContinuousConvMode = ENABLE;
	// 非连续转换
	ADC_Handle2.Init.DiscontinuousConvMode = DISABLE;
	// 非连续转换个数
	ADC_Handle2.Init.NbrOfDiscConversion = 0;	
  // 禁止外部边沿触发
  ADC_Handle2.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  // 外部触发通道，本例子使用软件触发，此值随便赋值即可
  //ADC_Handle2.Init.ExternalTrigConv = ADC_EXTERNALTRIGCONV_T1_CC1;
  // 数据右对齐	
  ADC_Handle2.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  // 转换通道 1个
  ADC_Handle2.Init.NbrOfConversion = 1;
	//使能连续转换请求
	ADC_Handle2.Init.DMAContinuousRequests = ENABLE;
	//转换完成标志
	ADC_Handle2.Init.EOCSelection = DISABLE;    
	// 初始化ADC	                          
	HAL_ADC_Init(&ADC_Handle2);
	
  //---------------------------------------------------------------------------	
	// 配置 ADC1 通道13转换顺序为1，第一个转换，采样时间为3个时钟周期
	ADC_Config.Channel      = MMA7361L_ADC2_CHANNEL;
	ADC_Config.Rank         = 1;    
	ADC_Config.SamplingTime = ADC_SAMPLETIME_3CYCLES;// 采样时间间隔	
	ADC_Config.Offset       = 0;
	HAL_ADC_ConfigChannel(&ADC_Handle2, &ADC_Config);
  //---------------------------------------------------------------------------

  // -------------------ADC3 Init 结构体 参数 初始化--------------------------
	ADC_Handle3.Instance = MMA7361L_ADC3;
	// 时钟为fpclk 4分频
  ADC_Handle3.Init.ClockPrescaler = ADC_CLOCKPRESCALER_PCLK_DIV4;
  // ADC 分辨率
  ADC_Handle3.Init.Resolution = ADC_RESOLUTION_12B;
  // 禁止扫描模式，多通道采集才需要	
  ADC_Handle3.Init.ScanConvMode = DISABLE; 
  // 连续转换	
  ADC_Handle3.Init.ContinuousConvMode = ENABLE;
	// 非连续转换
	ADC_Handle3.Init.DiscontinuousConvMode = DISABLE;
	// 非连续转换个数
	ADC_Handle3.Init.NbrOfDiscConversion = 0;	
  // 禁止外部边沿触发
  ADC_Handle3.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  // 外部触发通道，本例子使用软件触发，此值随便赋值即可
  //ADC_Handle3.Init.ExternalTrigConv = ADC_EXTERNALTRIGCONV_T1_CC1;
  // 数据右对齐	
  ADC_Handle3.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  // 转换通道 1个
  ADC_Handle3.Init.NbrOfConversion = 1;
	//使能连续转换请求
	ADC_Handle3.Init.DMAContinuousRequests = ENABLE;
	//转换完成标志
	ADC_Handle3.Init.EOCSelection = DISABLE;    
	// 初始化ADC	                          
	HAL_ADC_Init(&ADC_Handle3);
	
  //---------------------------------------------------------------------------	
	// 配置 ADC1 通道13转换顺序为1，第一个转换，采样时间为3个时钟周期
	ADC_Config.Channel      = MMA7361L_ADC3_CHANNEL;
	ADC_Config.Rank         = 1;    
	ADC_Config.SamplingTime = ADC_SAMPLETIME_3CYCLES;// 采样时间间隔	
	ADC_Config.Offset       = 0;
	HAL_ADC_ConfigChannel(&ADC_Handle3, &ADC_Config);
  //---------------------------------------------------------------------------

	/*配置三重AD采样*/
	mode.Mode = ADC_TRIPLEMODE_REGSIMULT;
	mode.DMAAccessMode = ADC_DMAACCESSMODE_1;
	mode.TwoSamplingDelay = ADC_TWOSAMPLINGDELAY_5CYCLES;
    
	HAL_ADCEx_MultiModeConfigChannel(&ADC_Handle1, &mode);
    
	HAL_ADC_Start(&ADC_Handle2);
	HAL_ADC_Start(&ADC_Handle3);	
    
	__HAL_LINKDMA(&ADC_Handle1, DMA_Handle, DMA_Init_Handle);   
	__HAL_LINKDMA(&ADC_Handle2, DMA_Handle, DMA_Init_Handle);
	__HAL_LINKDMA(&ADC_Handle3, DMA_Handle, DMA_Init_Handle);  
	HAL_ADCEx_MultiModeStart_DMA(&ADC_Handle1, (uint32_t *)ADC_ConvertedValue, 3);
}


void MMA7361L_Config(void)
{
	MMA7361L_ADC_GPIO_Config();
	MMA7361L_ADC_Mode_Config();
}



